#!/bin/bash
# docker-install-gnu - Docker installation script for Linux/GNU systems
# Supports: Ubuntu, Debian, Fedora, CentOS, RHEL, Arch Linux

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Docker Installation Script for Linux${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Please run as root or with sudo${NC}"
    exit 1
fi

# Detect OS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
    VERSION=$VERSION_ID
else
    echo -e "${RED}Cannot detect OS. /etc/os-release not found.${NC}"
    exit 1
fi

echo -e "${YELLOW}Detected OS: $OS $VERSION${NC}"
echo ""

# Function to install Docker on Ubuntu/Debian
install_docker_debian() {
    echo -e "${GREEN}Installing Docker on Debian/Ubuntu...${NC}"

    # Update package index
    apt-get update

    # Install prerequisites
    apt-get install -y \
        ca-certificates \
        curl \
        gnupg \
        lsb-release

    # Add Docker's official GPG key
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/$OS/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg

    # Set up the repository
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/$OS \
      $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

    # Install Docker Engine
    apt-get update
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
}

# Function to install Docker on Fedora/RHEL/CentOS
install_docker_fedora() {
    echo -e "${GREEN}Installing Docker on Fedora/RHEL/CentOS...${NC}"

    # Remove old versions
    dnf remove -y docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-selinux \
                  docker-engine-selinux \
                  docker-engine 2>/dev/null || true

    # Install prerequisites
    dnf install -y dnf-plugins-core

    # Add Docker repository
    dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo

    # Install Docker Engine
    dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
}

# Function to install Docker on Arch Linux
install_docker_arch() {
    echo -e "${GREEN}Installing Docker on Arch Linux...${NC}"

    # Update package database
    pacman -Sy

    # Install Docker
    pacman -S --noconfirm docker docker-compose
}

# Install based on detected OS
case $OS in
    ubuntu|debian)
        install_docker_debian
        ;;
    fedora|rhel|centos)
        install_docker_fedora
        ;;
    arch|manjaro)
        install_docker_arch
        ;;
    *)
        echo -e "${RED}Unsupported OS: $OS${NC}"
        echo "This script supports: Ubuntu, Debian, Fedora, RHEL, CentOS, Arch Linux"
        exit 1
        ;;
esac

# Start and enable Docker service
echo ""
echo -e "${GREEN}Starting Docker service...${NC}"
systemctl start docker
systemctl enable docker

# Add current user to docker group (if not root)
if [ -n "$SUDO_USER" ]; then
    echo -e "${GREEN}Adding $SUDO_USER to docker group...${NC}"
    usermod -aG docker $SUDO_USER
    echo -e "${YELLOW}Note: You need to log out and back in for group changes to take effect${NC}"
fi

# Verify installation
echo ""
echo -e "${GREEN}Verifying Docker installation...${NC}"
docker --version
docker compose version

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Docker installed successfully!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
