#!/bin/bash
# docker-install-mac - Docker Desktop installation script for macOS

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Docker Desktop Installation for macOS${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# Check if running on macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
    echo -e "${RED}This script is for macOS only!${NC}"
    exit 1
fi

# Detect architecture
ARCH=$(uname -m)
echo -e "${YELLOW}Detected architecture: $ARCH${NC}"
echo ""

# Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
    echo -e "${YELLOW}Homebrew not found. Installing Homebrew first...${NC}"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH for Apple Silicon
    if [[ "$ARCH" == "arm64" ]]; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

# Check if Docker is already installed
if [ -d "/Applications/Docker.app" ]; then
    echo -e "${YELLOW}Docker Desktop is already installed.${NC}"
    read -p "Do you want to reinstall? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}Installation cancelled.${NC}"
        exit 0
    fi
    echo -e "${YELLOW}Removing existing Docker Desktop...${NC}"
    brew uninstall --cask docker 2>/dev/null || true
fi

# Install Docker Desktop using Homebrew
echo -e "${GREEN}Installing Docker Desktop...${NC}"
brew install --cask docker

# Wait for installation to complete
echo ""
echo -e "${YELLOW}Waiting for installation to complete...${NC}"
sleep 3

# Start Docker Desktop
echo -e "${GREEN}Starting Docker Desktop...${NC}"
open -a Docker

echo ""
echo -e "${YELLOW}Waiting for Docker to start (this may take a minute)...${NC}"

# Wait for Docker to be ready
counter=0
max_attempts=60
while ! docker info &> /dev/null; do
    sleep 2
    counter=$((counter + 1))
    if [ $counter -eq $max_attempts ]; then
        echo -e "${RED}Docker failed to start within expected time.${NC}"
        echo -e "${YELLOW}Please start Docker Desktop manually from Applications.${NC}"
        exit 1
    fi
    echo -n "."
done

echo ""
echo -e "${GREEN}Docker is running!${NC}"

# Verify installation
echo ""
echo -e "${GREEN}Verifying Docker installation...${NC}"
docker --version
docker compose version

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Docker Desktop installed successfully!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "1. Docker Desktop is now running"
echo "2. Test: docker run hello-world"
echo "3. Access Docker Desktop from the menu bar"
echo ""
echo -e "${YELLOW}Tips:${NC}"
echo "- Docker Desktop settings: Click Docker icon in menu bar â†’ Preferences"
echo "- Enable 'Start Docker Desktop when you log in' in preferences"
echo "- Allocate resources (CPU/Memory) in Resources tab"
echo ""
